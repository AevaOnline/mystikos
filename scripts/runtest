#!/bin/bash

if [ "$#" == "0" ]; then
    echo "Usage: $0 <test> <args...>"
    exit 1
fi

if [ -z "${TESTNAME}" ]; then
    echo "$0: TESTNAME is undefined"
    exit 1
fi

if [ -z "${TESTDIR}" ]; then
    echo "$0: TESTDIR is undefined"
    exit 1
fi

if [ -z "${TESTSUBDIR}" ]; then
    echo "$0: TESTSUBDIR is undefined"
    exit 1
fi

# Use colors if stdout is a tty device (non-batch mode)
if [ -t 1 ]; then
    green="\e[32m"
    red="\e[31m"
    lightblue="\e[94m"
    default="\e[39m"
else
    green=
    red=
    lightblue=
    default=
fi

test_passed()
{
    local cmd=$*
    echo -n -e ${green}
    echo "    passed (${TESTNAME})"
    echo -n -e ${default}
    echo "" >> ${TESTSUBDIR}/passed
}

test_failed()
{
    local cmd;

    cmd=$*
    echo -n -e ${red}
    echo "    failed (${TESTNAME})"
    echo -n -e ${default}
    echo "" >> ${TESTSUBDIR}/failed
}

test_timedout()
{
    local cmd;

    cmd=$*
    echo -n -e ${red}
    echo "    timedout (${TESTNAME})"
    echo -n -e ${default}
    echo "" >> ${TESTSUBDIR}/failed
}

timeout=10

print_output()
{
    if [ "${VERBOSE}" == "1" ]; then
        echo -n -e ${lightblue}
        echo "======================= BEGIN OUTPUT ======================="
        cat ${TESTSUBDIR}/stdout
        cat ${TESTSUBDIR}/stderr
        echo "======================== END OUTPUT ========================"
        echo -n -e ${default}
    fi
}

run_test()
{
    local cmd;

    # Remove extraneous whitespace from the command:
    for i in $*
    do
        cmd="${cmd} $i"
    done

    echo "=== start (${TESTNAME})"

    local tempfile=$(/bin/mktemp)

    # run the test
    timeout="/usr/bin/timeout ${timeout}"
    time="/usr/bin/time -f "%e" --quiet -o ${tempfile}"
    echo ${cmd} > ${TESTSUBDIR}/stdout
    ${timeout} ${time} ${cmd} >> ${TESTSUBDIR}/stdout 2> ${TESTSUBDIR}/stderr
    ret=$?
    seconds=$(cat ${tempfile})
    rm -f ${tempfile}

    if [ "${ret}" == "0" ]; then
        print_output
        test_passed $cmd
        echo "    ${seconds} seconds"
    elif [ "${ret}" == "124" ]; then
        print_output
        test_timedout $cmd
    else
        print_output
        test_failed ${cmd}
        echo "    ${seconds} seconds"
    fi

    echo ""
}

summarize()
{
    if [ "${SUMMARY}" == "1" ]; then
        find ${TESTDIR} -name 'failed' | wc -l > ${TESTDIR}/num.failed
        find ${TESTDIR} -name 'passed' | wc -l > ${TESTDIR}/num.passed
        num_passed=$(cat ${TESTDIR}/num.passed)
        num_failed=$(cat ${TESTDIR}/num.failed)
        echo "passed: ${num_passed}"
        echo "failed: ${num_failed}"

        exit ${num_failed}
    fi
}

mkdir -p ${TESTSUBDIR}

if [ ! -d "${TESTSUBDIR}" ]; then
    echo "$0: cannot created directory: ${TESTSUBDIR}"
    exit 1
fi

run_test $*

summarize
